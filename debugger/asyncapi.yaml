asyncapi: 3.0.0
info:
  title: ksplang Debugger WebSocket API
  version: 1.0.0
  description: |
    WebSocket API for the ksplang debugger that allows real-time debugging of ksplang programs.
    
    The API provides functionality to:
    - Set and modify programs
    - Control the execution stack
    - Step through program execution
    - Receive real-time state updates

servers:
  development:
    host: localhost:8080
    protocol: ws
    description: Development server

channels:
  /ws:
    address: /ws
    messages:
      frontendRequest:
        $ref: '#/components/messages/FrontendRequest'
      stateMessage:
        $ref: '#/components/messages/StateMessage'

operations:
  receiveFrontendRequest:
    action: receive
    channel:
      $ref: '#/channels/~1ws'
    messages:
      - $ref: '#/components/messages/FrontendRequest'
    summary: Receive commands from frontend
    description: Handle various debugging commands from the frontend client

  sendStateMessage:
    action: send
    channel:
      $ref: '#/channels/~1ws'
    messages:
      - $ref: '#/components/messages/StateMessage'
    summary: Send state updates to frontend
    description: Send current debugger state to the frontend client

components:
  messages:
    FrontendRequest:
      name: FrontendRequest
      title: Frontend Request
      summary: Commands sent from frontend to control the debugger
      contentType: application/json
      payload:
        $ref: '#/components/schemas/FrontendRequest'

    StateMessage:
      name: StateMessage
      title: State Message
      summary: State updates sent from debugger to frontend
      contentType: application/json
      payload:
        $ref: '#/components/schemas/StateMessage'

  schemas:
    FrontendRequest:
      oneOf:
        - $ref: '#/components/schemas/SetProgram'
        - $ref: '#/components/schemas/SetStack'
        - $ref: '#/components/schemas/StepTo'
      discriminator:
        propertyName: type

    SetProgram:
      type: object
      required:
        - type
        - program
      properties:
        type:
          type: string
          const: set_program
        program:
          $ref: '#/components/schemas/AnnotatedKsplangTree'
      description: Set a new program to debug

    SetStack:
      type: object
      required:
        - type
        - stack
      properties:
        type:
          type: string
          const: set_stack
        stack:
          type: array
          items:
            type: integer
            format: int64
          description: Initial stack values
      description: Set the initial stack for program execution

    StepTo:
      type: object
      required:
        - type
        - executedInstructions
      properties:
        type:
          type: string
          const: step_to
        executedInstructions:
          type: integer
          format: int64
          description: Target number of executed instructions (absolute)
      description: Step execution to a specific instruction count

    StateMessage:
      oneOf:
        - $ref: '#/components/schemas/NewState'
      discriminator:
        propertyName: type

    NewState:
      type: object
      required:
        - type
        - ip
        - stack
        - reversed
      properties:
        type:
          type: string
          const: state
        ip:
          type: integer
          description: Current instruction pointer
        stack:
          type: array
          items:
            type: integer
            format: int64
          description: Current execution stack
        reversed:
          type: boolean
          description: Whether execution is in reversed mode
        error:
          type: string
          nullable: true
          description: Error message if an error occurred during execution, null if no error
      description: Current state of the debugger

    AnnotatedKsplangTree:
      oneOf:
        - $ref: '#/components/schemas/KsplangOp'
        - $ref: '#/components/schemas/KsplangBlock'
        - $ref: '#/components/schemas/KsplangRoot'
      discriminator:
        propertyName: type
      description: |
        Annotated ksplang program tree structure that represents a parsed and annotated 
        ksplang program ready for debugging. The tree can contain operations, blocks, or be a root node.

    KsplangOp:
      type: object
      required:
        - type
        - instruction
      properties:
        type:
          type: string
          const: op
        instruction:
          type: string
          description: The ksplang instruction/operation to execute (low-level ksplang instructions)
          examples:
            - "CS"
            - "++"
            - "lensum"
            - "funkcia"
            - "pop"
            - "pop2"
            - "j"
            - "praise"
            - "qeq"
            - "lroll"
            - "swap"
            - "bitshift"
            - "gcd"
            - "max"
            - "rem"
            - "tetr"
            - "m"
            - "u"
      description: A single ksplang operation/instruction

    KsplangBlock:
      type: object
      required:
        - type
        - blockType
        - children
      properties:
        type:
          type: string
          const: block
        name:
          type: string
          nullable: true
          description: Optional name of the block (e.g., function name)
        blockType:
          $ref: '#/components/schemas/BlockType'
        children:
          type: array
          items:
            $ref: '#/components/schemas/AnnotatedKsplangTree'
          description: Child nodes within this block
      description: A code block containing other operations or blocks

    KsplangRoot:
      type: object
      required:
        - type
        - children
      properties:
        type:
          type: string
          const: root
        children:
          type: array
          items:
            $ref: '#/components/schemas/AnnotatedKsplangTree'
          description: Top-level children in the program
      description: Root node of the ksplang program tree

    BlockType:
      oneOf:
        - $ref: '#/components/schemas/InlinedFunction'
        - $ref: '#/components/schemas/FunctionCall'
      discriminator:
        propertyName: type
      description: Type of code block in the ksplang program

    InlinedFunction:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          const: inlined_function
      description: A function that has been inlined into the program

    FunctionCall:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          const: function_call
      description: A function call block

  examples:
    SetProgramExample:
      summary: Example of setting a new program with actual ksplang instructions
      value:
        type: set_program
        program:
          type: root
          children:
            - type: block
              name: double
              blockType:
                type: inlined_function
              children:
                - type: op
                  instruction: "CS"
                - type: op
                  instruction: "++"
            - type: block
              name: null
              blockType:
                type: function_call
              children:
                - type: op
                  instruction: "lensum"
                - type: op
                  instruction: "CS"
                - type: op
                  instruction: "funkcia"

    ComplexProgramExample:
      summary: Example of a more complex nested program structure with real ksplang instructions
      value:
        type: set_program
        program:
          type: root
          children:
            - type: block
              name: "factorial"
              blockType:
                type: inlined_function
              children:
                - type: op
                  instruction: "CS"
                - type: op
                  instruction: "CS"
                - type: op
                  instruction: "lensum"
                - type: block
                  name: "loop"
                  blockType:
                    type: function_call
                  children:
                    - type: op
                      instruction: "pop2"
                    - type: op
                      instruction: "lroll"
                    - type: op
                      instruction: "swap"

    SetStackExample:
      summary: Example of setting initial stack
      value:
        type: set_stack
        stack: [1, 2, 3]

    StepToExample:
      summary: Example of stepping to instruction 10
      value:
        type: step_to
        executedInstructions: 10

    NewStateExample:
      summary: Example of current debugger state without error
      value:
        type: state
        ip: 5
        stack: [1, 2, 3, 26]
        reversed: false
        error: null

    NewStateWithErrorExample:
      summary: Example of current debugger state with an execution error
      value:
        type: state
        ip: 8
        stack: [42]
        reversed: false
        error: "Stack underflow: attempted to pop from empty stack"
